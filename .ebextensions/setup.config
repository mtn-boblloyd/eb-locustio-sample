# Copyright 2015-2015 Amazon.com, Inc. or its affiliates. All Rights Reserved.
#
# Licensed under the Apache License, Version 2.0 (the "License"). You may not use this file
# except in compliance with the License. A copy of the License is located at
#
#     http://aws.amazon.com/apache2.0/
#
# or in the "license" file accompanying this file. This file is distributed on an "AS IS"
# BASIS, WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied. See the
# License for the specific language governing permissions and limitations under the License.

packages:
  yum:
    gcc: []
    gcc-c++: []
    make: []
    patch: []
    zlib-devel: []
    bzip2: []
    bzip2-devel: []
    readline-devel: []
    sqlite: []
    sqlite-devel: []
    openssl-devel: []
    tk-devel: []
    libffi-devel: []
    xz-devel: []
    git: []

commands:
  01install_pyenv:
    command: | 
      if [ ! -d /root/.pyenv ]; then
        curl https://pyenv.run | bash; 
      fi

  02update_bashrc:
    command: |
      if ! grep -q "export PYENV_ROOT" ~/.bashrc; then
        echo 'export PYENV_ROOT="$HOME/.pyenv"' >> ~/.bashrc 
        echo 'command -v pyenv >/dev/null || export PATH="$PYENV_ROOT/bin:$PATH"' >> ~/.bashrc 
        echo 'export PATH="$PYENV_ROOT/shims:$PATH"' >> ~/.bashrc 
        echo 'eval "$(pyenv init -)"' >> ~/.02update_bashrc
      fi

  03update_profile:
    command: |
      if ! grep -q "export PYENV_ROOT" ~/.bash_profile; then
        echo 'export PYENV_ROOT="$HOME/.pyenv"' >> ~/.bash_profile 
        echo 'command -v pyenv >/dev/null || export PATH="$PYENV_ROOT/bin:$PATH"' >> ~/.bash_profile
        echo 'export PATH="$PYENV_ROOT/shims:$PATH"' >> ~/.bash_profile 
        echo 'eval "$(pyenv init -)"' >> ~/.bash_profile
      fi

  04install_python310:
    command: |
      source ~/.bashrc 
      if [ "$(pyenv shims | grep python3.10)" == "" ]; then        
        eval "$(pyenv init -)" 
        pyenv install 3.10.4 && pyenv global 3.10.4
      fi

  05install_packages:
    command: |
      source ~/.bashrc 
      eval "$(pyenv init -)" 
      python -m pip install locust==2.16.1 locust-plugins==4.0.0 paho-mqtt==1.6.1 websocket-client==1.6.2 ujson
  
  07create_home_dir:
    command: "mkdir -p /home/webapp | chown webapp:webapp /home/webapp"
  
  08copy_deploy_manifest:
    command: "cp /opt/elasticbeanstalk/deployment/app_version_manifest.json /tmp/manifest; chmod 777 /tmp/manifest"
  
  09update_webapp_bashrc:
    command: |
      if ! grep -q "export PYENV_ROOT" /home/webapp/.bashrc; then
        echo 'export PYENV_ROOT="$HOME/.pyenv"' >> /home/webapp/.bashrc
        echo 'command -v pyenv >/dev/null || export PATH="$PYENV_ROOT/bin:$PATH"' >> /home/webapp/.bashrc
        echo 'export PATH="$PYENV_ROOT/shims:$PATH"' >> /home/webapp/.bashrc
        echo 'eval "$(pyenv init -)"' >> /home/webapp/.bashrc
      fi
  
  10update_webapp_profile:
    command: |
      if ! grep -q "export PYENV_ROOT" /home/webapp/.bash_profile; then
        echo 'export PYENV_ROOT="$HOME/.pyenv"' >> /home/webapp/.bash_profile
        echo 'command -v pyenv >/dev/null || export PATH="$PYENV_ROOT/bin:$PATH"' >> /home/webapp/.bash_profile
        echo 'export PATH="$PYENV_ROOT/shims:$PATH"' >> /home/webapp/.bash_profile
        echo 'eval "$(pyenv init -)"' >> /home/webapp/.bash_profile
      fi

files:
  # add configuration to display the locust log files when tailing logs
  "/opt/elasticbeanstalk/tasks/taillogs.d/locustio.conf":
    owner: root
    group: root
    mode: "000644"
    content: |
      /var/log/locust-master*.log
      /var/log/locust-follower*.log